<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1847px" preserveAspectRatio="none" style="width:1516px;height:1847px;" version="1.1" viewBox="0 0 1516 1847" width="1516px" zoomAndPan="magnify"><defs><filter height="300%" id="f1oajz3ksunwo2" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1oajz3ksunwo2)" height="147.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="228.5" y="657.2266"/><rect fill="#FFFFFF" filter="url(#f1oajz3ksunwo2)" height="827.7266" style="stroke: #000000; stroke-width: 2.0;" width="1303.5" x="191" y="111.4297"/><rect fill="#FFFFFF" filter="url(#f1oajz3ksunwo2)" height="470.7266" style="stroke: #000000; stroke-width: 2.0;" width="1283.5" x="201" y="135.5625"/><rect fill="#FFFFFF" height="325.8672" style="stroke: none; stroke-width: 1.0;" width="1303.5" x="191" y="613.2891"/><rect fill="#FFFFFF" filter="url(#f1oajz3ksunwo2)" height="216.6016" style="stroke: #000000; stroke-width: 2.0;" width="1181.5" x="145" y="1091.6875"/><rect fill="#FFFFFF" height="56.9375" style="stroke: none; stroke-width: 1.0;" width="1181.5" x="145" y="1251.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="233" x2="233" y1="51.2969" y2="1789.8828"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="638" x2="638" y1="51.2969" y2="1789.8828"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="906.5" x2="906.5" y1="51.2969" y2="1789.8828"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1291.5" x2="1291.5" y1="51.2969" y2="1789.8828"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="39" x="211" y="47.9951">shost</text><ellipse cx="233.5" cy="19" fill="#FEFECE" filter="url(#f1oajz3ksunwo2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="221.5" x2="245.5" y1="33" y2="33"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="39" x="211" y="1801.8779">shost</text><ellipse cx="233.5" cy="1821.1797" fill="#FEFECE" filter="url(#f1oajz3ksunwo2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="221.5" x2="245.5" y1="1835.1797" y2="1835.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="614" y="47.9951">slibvirt</text><ellipse cx="638.5" cy="19" fill="#FEFECE" filter="url(#f1oajz3ksunwo2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="626.5" x2="650.5" y1="33" y2="33"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="43" x="614" y="1801.8779">slibvirt</text><ellipse cx="638.5" cy="1821.1797" fill="#FEFECE" filter="url(#f1oajz3ksunwo2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="626.5" x2="650.5" y1="1835.1797" y2="1835.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="883.5" y="47.9951">dhost</text><ellipse cx="906.5" cy="19" fill="#FEFECE" filter="url(#f1oajz3ksunwo2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="894.5" x2="918.5" y1="33" y2="33"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="883.5" y="1801.8779">dhost</text><ellipse cx="906.5" cy="1821.1797" fill="#FEFECE" filter="url(#f1oajz3ksunwo2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="894.5" x2="918.5" y1="1835.1797" y2="1835.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="1266.5" y="47.9951">dlibvirt</text><ellipse cx="1291.5" cy="19" fill="#FEFECE" filter="url(#f1oajz3ksunwo2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1279.5" x2="1303.5" y1="33" y2="33"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="44" x="1266.5" y="1801.8779">dlibvirt</text><ellipse cx="1291.5" cy="1821.1797" fill="#FEFECE" filter="url(#f1oajz3ksunwo2)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1279.5" x2="1303.5" y1="1835.1797" y2="1835.1797"/><rect fill="#FFFFFF" filter="url(#f1oajz3ksunwo2)" height="147.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="228.5" y="657.2266"/><rect fill="#EEEEEE" filter="url(#f1oajz3ksunwo2)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1501.5" x="3" y="81.8633"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1504.5" y1="81.8633" y2="81.8633"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1504.5" y1="84.8633" y2="84.8633"/><rect fill="#EEEEEE" filter="url(#f1oajz3ksunwo2)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="175" x="666.25" y="71.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="672.25" y="87.3638">pre_live_migration 阶段</text><path d="M191,111.4297 L255,111.4297 L255,118.4297 L245,128.4297 L191,128.4297 L191,111.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="827.7266" style="stroke: #000000; stroke-width: 2.0;" width="1303.5" x="191" y="111.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="206" y="124.4966">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="233" x="270" y="123.6401">[pre_live_migration successful case]</text><path d="M201,135.5625 L353,135.5625 L353,142.5625 L343,152.5625 L201,152.5625 L201,135.5625 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="470.7266" style="stroke: #000000; stroke-width: 2.0;" width="1283.5" x="201" y="135.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107" x="216" y="148.6294">try...exception</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="275.5" y1="173.8281" y2="173.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="275.5" x2="275.5" y1="173.8281" y2="186.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="234.5" x2="275.5" y1="186.8281" y2="186.8281"/><polygon fill="#A80036" points="244.5,182.8281,234.5,186.8281,244.5,190.8281,240.5,186.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="240.5" y="168.7622">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="253.5" y="168.7622">设置虚拟机的 migration 状态为 `preparing`</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="275.5" y1="215.9609" y2="215.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="275.5" x2="275.5" y1="215.9609" y2="228.9609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="234.5" x2="275.5" y1="228.9609" y2="228.9609"/><polygon fill="#A80036" points="244.5,224.9609,234.5,228.9609,244.5,232.9609,240.5,228.9609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="240.5" y="210.895">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="253.5" y="210.895">获取虚拟机的卷信息</text><polygon fill="#A80036" points="894.5,254.0938,904.5,258.0938,894.5,262.0938,898.5,258.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="900.5" y1="258.0938" y2="258.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="240.5" y="253.0278">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="375" x="253.5" y="253.0278">(RPC call) pre_live_migration() 在 dhost 上提前准备虚拟机迁移所需要的资源</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="948.5" y1="287.2266" y2="287.2266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="948.5" y1="287.2266" y2="300.2266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="948.5" y1="300.2266" y2="300.2266"/><polygon fill="#A80036" points="917.5,296.2266,907.5,300.2266,917.5,304.2266,913.5,300.2266" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="913.5" y="282.1606">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="926.5" y="282.1606">获取虚拟机的卷信息</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="948.5" y1="329.3594" y2="329.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="948.5" y1="329.3594" y2="342.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="948.5" y1="342.3594" y2="342.3594"/><polygon fill="#A80036" points="917.5,338.3594,907.5,342.3594,917.5,346.3594,913.5,342.3594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="913.5" y="324.2935">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="926.5" y="324.2935">获取虚拟机的网络信息</text><polygon fill="#A80036" points="1279.5,367.4922,1289.5,371.4922,1279.5,375.4922,1283.5,371.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="1285.5" y1="371.4922" y2="371.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="913.5" y="366.4263">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="926.5" y="366.4263">调用 Libvirt Driver 执行 driver.pre_live_migration</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1291.5" x2="1333.5" y1="400.625" y2="400.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1333.5" x2="1333.5" y1="400.625" y2="413.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1292.5" x2="1333.5" y1="413.625" y2="413.625"/><polygon fill="#A80036" points="1302.5,409.625,1292.5,413.625,1302.5,417.625,1298.5,413.625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1298.5" y="395.5591">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="1311.5" y="395.5591">获取虚拟机镜像 image_meta 信息</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1291.5" x2="1333.5" y1="442.7578" y2="442.7578"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1333.5" x2="1333.5" y1="442.7578" y2="455.7578"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1292.5" x2="1333.5" y1="455.7578" y2="455.7578"/><polygon fill="#A80036" points="1302.5,451.7578,1292.5,455.7578,1302.5,459.7578,1298.5,455.7578" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1298.5" y="437.6919">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="1311.5" y="437.6919">创建虚拟机本地目录</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1291.5" x2="1333.5" y1="484.8906" y2="484.8906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1333.5" x2="1333.5" y1="484.8906" y2="497.8906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1292.5" x2="1333.5" y1="497.8906" y2="497.8906"/><polygon fill="#A80036" points="1302.5,493.8906,1292.5,497.8906,1302.5,501.8906,1298.5,497.8906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1298.5" y="479.8247">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1311.5" y="479.8247">连接虚拟机卷</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1291.5" x2="1333.5" y1="527.0234" y2="527.0234"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1333.5" x2="1333.5" y1="527.0234" y2="540.0234"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1292.5" x2="1333.5" y1="540.0234" y2="540.0234"/><polygon fill="#A80036" points="1302.5,536.0234,1292.5,540.0234,1302.5,544.0234,1298.5,540.0234" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1298.5" y="521.9575">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="1320.5" y="521.9575">创建虚拟机网卡并添加到 br-int</text><polygon fill="#A80036" points="917.5,565.1563,907.5,569.1563,917.5,573.1563,913.5,569.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="911.5" x2="1290.5" y1="569.1563" y2="569.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="923.5" y="564.0903">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="945.5" y="564.0903">return pre_live_migration 执行结果</text><polygon fill="#A80036" points="244.5,594.2891,234.5,598.2891,244.5,602.2891,240.5,598.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="238.5" x2="905.5" y1="598.2891" y2="598.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="250.5" y="593.2231">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="196" x="272.5" y="593.2231">return pre_live_migration 执行结果</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="191" x2="1494.5" y1="614.2891" y2="614.2891"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="323" x="196" y="624.4995">[pre_live_migration failure case (catch exception)]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="280.5" y1="644.2266" y2="644.2266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="280.5" x2="280.5" y1="644.2266" y2="657.2266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239.5" x2="280.5" y1="657.2266" y2="657.2266"/><polygon fill="#A80036" points="249.5,653.2266,239.5,657.2266,249.5,661.2266,245.5,657.2266" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="245.5" y="639.1606">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="267.5" y="639.1606">_rollback_live_migration()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="238.5" x2="280.5" y1="691.3594" y2="691.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="280.5" x2="280.5" y1="691.3594" y2="704.3594"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="239.5" x2="280.5" y1="704.3594" y2="704.3594"/><polygon fill="#A80036" points="249.5,700.3594,239.5,704.3594,249.5,708.3594,245.5,704.3594" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="245.5" y="686.2935">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="267.5" y="686.2935">获取 dhost 中虚拟机的卷的 bdms 信息</text><polygon fill="#A80036" points="894.5,729.4922,904.5,733.4922,894.5,737.4922,898.5,733.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="238.5" x2="900.5" y1="733.4922" y2="733.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="245.5" y="728.4263">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="267.5" y="728.4263">(RPC call) 清除虚拟机的卷连接信息</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="948.5" y1="762.625" y2="762.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="948.5" y1="762.625" y2="775.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="948.5" y1="775.625" y2="775.625"/><polygon fill="#A80036" points="917.5,771.625,907.5,775.625,917.5,779.625,913.5,775.625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="913.5" y="757.5591">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="935.5" y="757.5591">获取虚拟机的 bdms 信息，终止 volume_connection 断开卷</text><polygon fill="#A80036" points="894.5,800.7578,904.5,804.7578,894.5,808.7578,898.5,804.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="900.5" y1="804.7578" y2="804.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="799.6919">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="399" x="262.5" y="799.6919">(RPC cast) 执行热迁移失败清理 rollback_live_migration_at_destination()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="948.5" y1="833.8906" y2="833.8906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="948.5" y1="833.8906" y2="846.8906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="948.5" y1="846.8906" y2="846.8906"/><polygon fill="#A80036" points="917.5,842.8906,907.5,846.8906,917.5,850.8906,913.5,846.8906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="913.5" y="828.8247">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="935.5" y="828.8247">清理虚拟机配置信息</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="948.5" y1="876.0234" y2="876.0234"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="948.5" y1="876.0234" y2="889.0234"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="948.5" y1="889.0234" y2="889.0234"/><polygon fill="#A80036" points="917.5,885.0234,907.5,889.0234,917.5,893.0234,913.5,889.0234" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="913.5" y="870.9575">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="935.5" y="870.9575">清理虚拟机网卡信息，将网卡从 br-int 上 unbind</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="948.5" y1="918.1563" y2="918.1563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="948.5" y1="918.1563" y2="931.1563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="948.5" y1="931.1563" y2="931.1563"/><polygon fill="#A80036" points="917.5,927.1563,907.5,931.1563,917.5,935.1563,913.5,931.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="913.5" y="913.0903">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="935.5" y="913.0903">清理 dhost 上的虚拟机目录</text><rect fill="#EEEEEE" filter="url(#f1oajz3ksunwo2)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1501.5" x="3" y="966.7227"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1504.5" y1="966.7227" y2="966.7227"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1504.5" y1="969.7227" y2="969.7227"/><rect fill="#EEEEEE" filter="url(#f1oajz3ksunwo2)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="139" x="684.25" y="956.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="690.25" y="972.2231">内存（本地系统盘）数据迁移阶段</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="275.5" y1="1010.4219" y2="1010.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="275.5" x2="275.5" y1="1010.4219" y2="1023.4219"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="234.5" x2="275.5" y1="1023.4219" y2="1023.4219"/><polygon fill="#A80036" points="244.5,1019.4219,234.5,1023.4219,244.5,1027.4219,240.5,1023.4219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="1005.356">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="220" x="262.5" y="1005.356">设置虚拟机的 migration 状态为 `migrating`</text><polygon fill="#A80036" points="626.5,1048.5547,636.5,1052.5547,626.5,1056.5547,630.5,1052.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="632.5" y1="1052.5547" y2="1052.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="1047.4888">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="262.5" y="1047.4888">正式进入 live migration 步骤</text><path d="M145,1091.6875 L297,1091.6875 L297,1098.6875 L287,1108.6875 L145,1108.6875 L145,1091.6875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="216.6016" style="stroke: #000000; stroke-width: 2.0;" width="1181.5" x="145" y="1091.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107" x="160" y="1104.7544">try...exception</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="638.5" x2="680.5" y1="1129.9531" y2="1129.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="680.5" x2="680.5" y1="1129.9531" y2="1142.9531"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="680.5" y1="1142.9531" y2="1142.9531"/><polygon fill="#A80036" points="649.5,1138.9531,639.5,1142.9531,649.5,1146.9531,645.5,1142.9531" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="645.5" y="1124.8872">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="667.5" y="1124.8872">获取虚拟机的 disk path</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="638.5" x2="680.5" y1="1172.0859" y2="1172.0859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="680.5" x2="680.5" y1="1172.0859" y2="1185.0859"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="639.5" x2="680.5" y1="1185.0859" y2="1185.0859"/><polygon fill="#A80036" points="649.5,1181.0859,639.5,1185.0859,649.5,1189.0859,645.5,1185.0859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="645.5" y="1167.02">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="667.5" y="1167.02">开启额外的协程，监控虚拟机内存（本次系统盘）数据的拷贝过程</text><polygon fill="#A80036" points="1279.5,1210.2188,1289.5,1214.2188,1279.5,1218.2188,1283.5,1214.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="638.5" x2="1285.5" y1="1214.2188" y2="1214.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="645.5" y="1209.1528">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="667.5" y="1209.1528">SSH/TCP &amp; Pre-Copy/Post-Copy 数据拷贝</text><polygon fill="#A80036" points="244.5,1239.3516,234.5,1243.3516,244.5,1247.3516,240.5,1243.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="238.5" x2="637.5" y1="1243.3516" y2="1243.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="250.5" y="1238.2856">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="272.5" y="1238.2856">live_migration 成功，进入 post_live_migration 阶段</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="145" x2="1326.5" y1="1252.3516" y2="1252.3516"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="296" x="150" y="1262.562">[live_migration failure case (catch exception)]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="275.5" y1="1287.2891" y2="1287.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="275.5" x2="275.5" y1="1287.2891" y2="1300.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="234.5" x2="275.5" y1="1300.2891" y2="1300.2891"/><polygon fill="#A80036" points="244.5,1296.2891,234.5,1300.2891,244.5,1304.2891,240.5,1300.2891" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="1282.2231">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="262.5" y="1282.2231">_rollback_live_migration()</text><path d="M155,1272.6563 L155,1297.6563 L224,1297.6563 L224,1282.6563 L214,1272.6563 L155,1272.6563 " fill="#FBFB77" filter="url(#f1oajz3ksunwo2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M214,1272.6563 L214,1282.6563 L224,1282.6563 L214,1272.6563 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="161" y="1289.7231">处理过程同上</text><rect fill="#EEEEEE" filter="url(#f1oajz3ksunwo2)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1501.5" x="3" y="1335.8555"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1504.5" y1="1335.8555" y2="1335.8555"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1504.5" y1="1338.8555" y2="1338.8555"/><rect fill="#EEEEEE" filter="url(#f1oajz3ksunwo2)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="199" x="654.25" y="1325.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="660.25" y="1341.356">post_live_migration 迁移阶段</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="275.5" y1="1379.5547" y2="1379.5547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="275.5" x2="275.5" y1="1379.5547" y2="1392.5547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="234.5" x2="275.5" y1="1392.5547" y2="1392.5547"/><polygon fill="#A80036" points="244.5,1388.5547,234.5,1392.5547,244.5,1396.5547,240.5,1392.5547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="1374.4888">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="262.5" y="1374.4888">获取虚拟机需要断开连接的 bdms 信息</text><polygon fill="#A80036" points="626.5,1422.6875,636.5,1426.6875,626.5,1430.6875,630.5,1426.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="632.5" y1="1426.6875" y2="1426.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="1421.6216">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="262.5" y="1421.6216">断开虚拟机 bdms 卷连接</text><path d="M56,1405.5547 L56,1430.5547 L224,1430.5547 L224,1415.5547 L214,1405.5547 L56,1405.5547 " fill="#FBFB77" filter="url(#f1oajz3ksunwo2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M214,1405.5547 L214,1415.5547 L224,1415.5547 L214,1405.5547 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="62" y="1422.6216">此时 shost 上的虚拟机正式不可访问</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="275.5" y1="1460.8203" y2="1460.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="275.5" x2="275.5" y1="1460.8203" y2="1473.8203"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="234.5" x2="275.5" y1="1473.8203" y2="1473.8203"/><polygon fill="#A80036" points="244.5,1469.8203,234.5,1473.8203,244.5,1477.8203,240.5,1473.8203" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="1455.7544">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="262.5" y="1455.7544">调用 cinder api 断开 shost 虚拟机的 bdms</text><polygon fill="#A80036" points="626.5,1498.9531,636.5,1502.9531,626.5,1506.9531,630.5,1502.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="632.5" y1="1502.9531" y2="1502.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="1497.8872">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="262.5" y="1497.8872">执行 post_live_migration_at_source() 清理 shost 上虚拟机的网卡信息</text><polygon fill="#A80036" points="894.5,1528.0859,904.5,1532.0859,894.5,1536.0859,898.5,1532.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="900.5" y1="1532.0859" y2="1532.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="1527.02">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="262.5" y="1527.02">(RPC cast) 执行 post_live_migration_at_destination()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="948.5" y1="1561.2188" y2="1561.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="948.5" y1="1561.2188" y2="1574.2188"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="948.5" y1="1574.2188" y2="1574.2188"/><polygon fill="#A80036" points="917.5,1570.2188,907.5,1574.2188,917.5,1578.2188,913.5,1574.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="913.5" y="1556.1528">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="935.5" y="1556.1528">获取虚拟机网络信息</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="948.5" y1="1603.3516" y2="1603.3516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="948.5" y1="1603.3516" y2="1616.3516"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="948.5" y1="1616.3516" y2="1616.3516"/><polygon fill="#A80036" points="917.5,1612.3516,907.5,1616.3516,917.5,1620.3516,913.5,1616.3516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="913.5" y="1598.2856">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="935.5" y="1598.2856">调用 neutron api 更新 port host 为 dhost</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="948.5" y1="1645.4844" y2="1645.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="948.5" y1="1645.4844" y2="1658.4844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="948.5" y1="1658.4844" y2="1658.4844"/><polygon fill="#A80036" points="917.5,1654.4844,907.5,1658.4844,917.5,1662.4844,913.5,1658.4844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="913.5" y="1640.4185">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="349" x="935.5" y="1640.4185">获取虚拟机的状态，并更新虚拟机的 host、power_state、task_state 等状态</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="906.5" x2="948.5" y1="1687.6172" y2="1687.6172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="948.5" x2="948.5" y1="1687.6172" y2="1700.6172"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="907.5" x2="948.5" y1="1700.6172" y2="1700.6172"/><polygon fill="#A80036" points="917.5,1696.6172,907.5,1700.6172,917.5,1704.6172,913.5,1700.6172" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="913.5" y="1682.5513">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="935.5" y="1682.5513">更新 dhost 资源</text><path d="M694,1672.9844 L694,1697.9844 L897,1697.9844 L897,1682.9844 L887,1672.9844 L694,1672.9844 " fill="#FBFB77" filter="url(#f1oajz3ksunwo2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M887,1672.9844 L887,1682.9844 L897,1682.9844 L887,1672.9844 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="700" y="1690.0513">dhost 上的 live migration 正式完成</text><polygon fill="#A80036" points="626.5,1725.75,636.5,1729.75,626.5,1733.75,630.5,1729.75" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="632.5" y1="1729.75" y2="1729.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="1724.6841">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="262.5" y="1724.6841">清理虚拟机在 shost 上的虚拟机目录、disk、config 等文件</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="233.5" x2="275.5" y1="1758.8828" y2="1758.8828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="275.5" x2="275.5" y1="1758.8828" y2="1771.8828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="234.5" x2="275.5" y1="1771.8828" y2="1771.8828"/><polygon fill="#A80036" points="244.5,1767.8828,234.5,1771.8828,244.5,1775.8828,240.5,1771.8828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="240.5" y="1753.8169">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="262.5" y="1753.8169">释放 shost 上虚拟机所占用的资源</text><path d="M22,1744.25 L22,1769.25 L224,1769.25 L224,1754.25 L214,1744.25 L22,1744.25 " fill="#FBFB77" filter="url(#f1oajz3ksunwo2)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M214,1744.25 L214,1754.25 L224,1754.25 L214,1744.25 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="28" y="1761.3169">shost 上的 live migration 正式完成</text><!--
@startuml
autonumber

entity shost
entity slibvirt
entity dhost
entity dlibvirt

== pre_live_migration 阶段 ==
alt pre_live_migration successful case
  group try...exception
    shost -> shost: 设置虚拟机的 migration 状态为 `preparing`
    shost -> shost: 获取虚拟机的卷信息
    shost -> dhost: (RPC call) pre_live_migration() 在 dhost 上提前准备虚拟机迁移所需要的资源
    dhost -> dhost: 获取虚拟机的卷信息
    dhost -> dhost: 获取虚拟机的网络信息
    dhost -> dlibvirt: 调用 Libvirt Driver 执行 driver.pre_live_migration
    dlibvirt -> dlibvirt: 获取虚拟机镜像 image_meta 信息
    dlibvirt -> dlibvirt: 创建虚拟机本地目录
    dlibvirt -> dlibvirt: 连接虚拟机卷
    dlibvirt -> dlibvirt: 创建虚拟机网卡并添加到 br-int
    dlibvirt -> dhost: return pre_live_migration 执行结果
    dhost -> shost: return pre_live_migration 执行结果
  end
else pre_live_migration failure case (catch exception)
  shost -> shost: _rollback_live_migration()
  activate shost
    shost -> shost: 获取 dhost 中虚拟机的卷的 bdms 信息
    shost -> dhost: (RPC call) 清除虚拟机的卷连接信息
    dhost -> dhost: 获取虚拟机的 bdms 信息，终止 volume_connection 断开卷
    shost -> dhost: (RPC cast) 执行热迁移失败清理 rollback_live_migration_at_destination()
  deactivate shost
    dhost -> dhost: 清理虚拟机配置信息
    dhost -> dhost: 清理虚拟机网卡信息，将网卡从 br-int 上 unbind
    dhost -> dhost: 清理 dhost 上的虚拟机目录
end


== 内存（本地系统盘）数据迁移阶段 ==
shost -> shost: 设置虚拟机的 migration 状态为 `migrating`
shost -> slibvirt: 正式进入 live migration 步骤
alt live_migration successful case
  group try...exception
    slibvirt -> slibvirt: 获取虚拟机的 disk path
    slibvirt -> slibvirt: 开启额外的协程，监控虚拟机内存（本次系统盘）数据的拷贝过程
    slibvirt -> dlibvirt: SSH/TCP & Pre-Copy/Post-Copy 数据拷贝
    slibvirt -> shost: live_migration 成功，进入 post_live_migration 阶段
else live_migration failure case (catch exception)
  shost -> shost: _rollback_live_migration()
  note left: 处理过程同上
end


== post_live_migration 迁移阶段 ==
shost -> shost: 获取虚拟机需要断开连接的 bdms 信息
shost -> slibvirt: 断开虚拟机 bdms 卷连接
note left: 此时 shost 上的虚拟机正式不可访问
shost -> shost: 调用 cinder api 断开 shost 虚拟机的 bdms
shost -> slibvirt: 执行 post_live_migration_at_source() 清理 shost 上虚拟机的网卡信息
shost -> dhost: (RPC cast) 执行 post_live_migration_at_destination()
dhost -> dhost: 获取虚拟机网络信息
dhost -> dhost: 调用 neutron api 更新 port host 为 dhost
dhost -> dhost: 获取虚拟机的状态，并更新虚拟机的 host、power_state、task_state 等状态
dhost -> dhost: 更新 dhost 资源
note left: dhost 上的 live migration 正式完成
shost -> slibvirt: 清理虚拟机在 shost 上的虚拟机目录、disk、config 等文件
shost -> shost: 释放 shost 上虚拟机所占用的资源
note left: shost 上的 live migration 正式完成
@enduml

PlantUML version 1.2019.06(Sat May 25 01:10:25 CST 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.2+9
Operating System: Linux
OS Version: 4.15.0-1028-gcp
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>